# Домашнее задание по лекции "Инфраструктура". ШРИ 2019

## Описание

В рамках данной работы был разработан основной сервер, который обрабатывает команды исполнения скриптов в репозитории на заданном хеше коммита и распределяет эти задачи между серверами-агентами.

## Запуск

Запуск сервера:

```bash
cd server
npm i
npm start
```

Запуск агентов (по умолчанию запускаются три агента на портах [3001, 3002, 3003], можно регулировать в `config.js`):

```bash
cd agent
npm i
npm start
```

Открыть страницу отображения (по умолчанию `http://localhost:3000/`), ввести команду и хеш коммита и нажать на кнопку запуска.

## Конфигурация

> ***Важно:*** После выполнения агентом задачи, необходимо обновить страницу отображения (TODO: улучшить проект с помощью WebSockets и использованием БД вместо текстового файла)

По умолчанию сервер запускается на 3000 порту (можно конфигурировать в файле `config.js`), агенты — задаются также в массиве.

Если значения порта не конфигурировалось, то на `http://localhost:3000/` будет доступна страница с возможностью запустить новую сборку и просмотреть список текущих сборок. В файле `config.js` также можно редактировать URL репозитория, хост агента, а также имя файла, в который будут записываться данные (некая имитация базы данных, куда будет сохраняться информация о запущенных командах и сборках), по умолчанию `data.txt`. В папке `server/` находится исходный код сервера, а также файл `layoutUtils.js`, в котором лежат хелперы для создания верстки. Исходный код агента находится в `agent/`.

На главной странице будет отображен список сборок, с кодом процесса, командой, и датой начала и окончания исполнения процесса. Реализована возможность создания новой задачи для агента на исполнение с указанием ветки/хэша коммита и исполянемой команды. Все выполненные задачи отображаются на этой же странице в виде таблицы. Доступен переход на страницу просмотра деталей по каждой созданной задаче (`GET /build/<id сборки>`).

Если на данный момент нет свободных агентов, задания складываются в очередь. Затем, как один из агентов освобождается, он берет задачу из очереди. После окончания исполнения задачи, она может получить либо статус успешно выполненной, либо собранной с ошибкой. По окончании выполнения задачи агент отправляет результаты на главный сервер запросом `POST /notify_build_result`, после этого можно обновить страницу с отображением сервера.
